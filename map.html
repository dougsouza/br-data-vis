<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>

<script src="node_modules/d3/d3.js"></script>
<script src="node_modules/d3-geo-projection/d3.geo.projection.js"></script>
<script src="node_modules/topojson/build/topojson.js"></script>
<script src="node_modules/angular/angular.js"></script>
<script src="node_modules/datamaps/dist/datamaps.all.min.js"></script>


<body ng-app="mapApp" ng-controller='rChartsCtrl as chartsCtrl'>
    <input id='slider' type='range' min=2008 max=2015 ng-model='chartsCtrl.year' width=200>
	<span ng-bind='chartsCtrl.year'></span>
    <div id="container" style="position: relative; width: 960px; height: 400px;">
    

    </div>
</body>

<script type="text/javascript">
    var map = new Datamap({
        element: document.getElementById('container'),
        geographyConfig: {
            dataUrl: '/br-atlas/topo/br-states.json',
            highlightBorderColor: '#bada55',
            popupTemplate: function(geography, data) {
                return '<div class="hoverinfo">' + geography.properties.name + '<br /> NÃºmero de bolsas: ' +  data.numberOfScholarships + ' ';
            },
            highlightBorderWidth: 2
        },
        scope: 'states',
        setProjection: function(element, options) {
            var projection, path;
            projection = d3.geo.mercator()
					    .scale(500)
					    .translate([960, 50]);
            path = d3.geo.path().projection( projection );

            return {path: path, projection: projection};
        },
        fills: {LOW: '#ff3456'}
    });

    map.legend();
    // angular app...
    var app = angular.module('mapApp', []);
    app.controller('rChartsCtrl', ['$log', '$scope', '$http', function rChartsCtrl($log, $scope, $http){
        function updateMap(year){
            var data = $http.get('data/bolsaspos/'+year).then(function(data){
                var arr = data.data;
                var obj = {};
                // obj['fills'] = {'LOW': 'blue'};
                for(var i=0; i < arr.length; i++){
                    obj[arr[i].UF] = {numberOfScholarships: arr[i].Total, 'fillKey': 'LOW'};
                }
                // debugger;
                // var newData = data.data.map(function(value, index, arr){
                //     var obj = {};
                //     var content = {};
                //     content['numberOfThings'] = value.Total;
                //     content['fillKey'] = 'LOW';
                //     obj[value.UF] = content;
                //     obj['fills'] = {LOW: '#123456'};
                //     return obj;
                // });
                map.updateChoropleth(obj);
                
            }, function(err){throw err;});
        };
        //data/bolsaspos/2011
        var self = this;
        self.map = map;
        self.year = 2008;
        // debugger;
        $scope.$watch('chartsCtrl.year', function(newYear){
            updateMap(newYear);
            $log.log('slider value: ' + newYear);
            // map.updateChoropleth({RS: '#123456'});
            // map.updateChoropleth({'MT': '#123456'});
         });
    }]);
    

</script>

</html>